<!--
    @title
        fantasy.constellation Web GUI - sdk_test.html
    @author
        typedef
    @notes
        Function References:

        ~Line 35 -> constellation.memory.module
        ~Line 65 -> constellation.memory.pattern
        ~Line 88 -> constellation.get.localplayer & constellation.get.players
        ~Line 130 -> constellation.memory.netvar
        ~Line 142 -> constellation.memory.read
        ~Line 167 -> constellation.mouse.move
-->
<html>

    <head>
        <!-- script includes -->
        <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
        <script src="js/fantasy.constellation.js"></script>

        <!-- title -->
        <title>fantasy.constellation - sdk test.html</title>

        <!-- script -->
        <script>

            /// sdk_test.html loaded.
            $( document ).ready(function() 
            {
                /// get our current game
                game = constellation.game()

                /// get client.dll and engine.dll (engine2.dll for Dota 2)
                module_client = constellation.memory.module("client.dll")
                module_engine = constellation.memory.module("engine.dll")
                module_engine2 = constellation.memory.module("engine2.dll")

                /// check if client.dll is loaded. if not, then we're not ingame or Constellation isn't started.
                if( !module_client ) return

                /// display client.dll and engine.dll information.
                $("#game_information").html(
                    `
                        [${game}]<br />
                        client.dll: ${module_client.address}<br />
                        engine.dll: ${module_engine.address}<br />
                        engine2.dll: ${module_engine2.address}<br />
                    `
                );

                /// start timer to refresh player information.
                window.setInterval(timer_players, 1000);

                /*
                    [ignore if you don't understand memory manipulation]          
                    testing the pattern scanning function.

                    constellation.memory.pattern( mod, size, pattern, offset, extra, unrelative )
                */
                if( game == "CS:GO")
                {
                    /// https://github.com/frk1/hazedumper/blob/master/config.json#L285
                    dwLocalPlayer = constellation.memory.pattern( 
                        module_client.address, // client.dll
                        module_client.size, /// client.dll's size.
                        "8D 34 85 ? ? ? ? 89 15 ? ? ? ? 8B 41 08 8B 48 04 83 F9 FF", /// pattern
                        3, /// offset
                        4, /// extra
                        0, /// unrelativity
                     )

                     /// dwLocalPlayer should equal 14316652 | https://github.com/frk1/hazedumper/blob/master/csgo.json#L34
                     console.log( dwLocalPlayer )
                }
            });

            /// timer to refresh player information.
            function timer_players() 
            {
                /// get localplayer
                var localplayer = constellation.get.localplayer() 

                /// are we even ingame?
                if( localplayer == null ) return null

                /// we're ingame, get all players while we're at it
                var player_database = constellation.get.players() 

                /// set localplayer information.
                $("#localplayer_information").html(
                    `
                    Name: ${localplayer.name}<br />
                    Steam: ${localplayer.steam}<br />
                    X: ${localplayer.x}<br />
                    Y: ${localplayer.y}<br />
                    Z: ${localplayer.z}<br />
                    Viewangles X: ${localplayer.viewangles.x}<br />
                    Viewangles Y: ${localplayer.viewangles.y}<br />
                    Viewangles Z: ${localplayer.viewangles.z}<br />
                    `
                );   

                /// set all player information
                $('#player_information').html("<th>Name</th><th>Steam</th>")
                for( const property in player_database )
                {
                    const json_information = JSON.parse(player_database[property])
                    $('#player_information').append(`<tr><td>${json_information.name}</td><td>${json_information.steam}</td></tr>`);
                }

                ///===========================================================================
                /*
                    Testing further memory functions now.
                    Let's check if the localplayer (us) is in the middle of reloading.
                    Then display the information.
                */

                /// check if we're in CS:GO.
                if( game == "CS:GO")
                {
                    /// https://github.com/frk1/hazedumper/blob/master/config.json#L619
                    m_bInReload = constellation.memory.netvar( "DT_BaseCombatWeapon", "m_flNextPrimaryAttack" ) + 109

                    /// https://github.com/frk1/hazedumper/blob/master/config.json#L630
                    m_bIsScoped = constellation.memory.netvar( "DT_CSPlayer", "m_bIsScoped" )

                    /// it looks like we couldn't get the netvar for some reason
                    if( !m_bInReload ) return

                    /// check if we have a weapon.
                    if( !localplayer.weapon_address ) return 

                    /// read memory to check if we're scoped!
                    is_localplayer_scoped = constellation.memory.read( localplayer.address + m_bIsScoped )

                    /// read memory to check if we're reloading!
                    is_localplayer_reloading = constellation.memory.read( localplayer.weapon_address + m_bInReload )

                    /// yes, we are scoped
                    if( is_localplayer_scoped == 1 ) $("#localplayer_information").append("SCOPED!<br />");

                    /// yes, we are reloading
                    if( is_localplayer_reloading == 1 ) $("#localplayer_information").append("RELOADING!<br />");

                    /// annoying mode: make constelia talk every time you reload (not recommended)
                    ///if ( is_localplayer_scoped == 1 ) constellation.constelia.say( "Get cover! We're reloading!")
                }
            }
        </script>
    </head>

    <body>
        <div id="game_information"></div><br />
        <div id="localplayer_information"></div><br />
        <table id="player_information"></table><br />

        Mouse X: <input type="number" value="0"  id="mouse_x"><br />
        Mouse Y: <input type="number" value="0"  id="mouse_y"><br />
        <button onclick="constellation.mouse.move($('#mouse_x').val(), $('#mouse_y').val())">Move Mouse</button><br />
    </body>

</html>